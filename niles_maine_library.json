SELECT TRANS_ID,
       BU_SID,
       FACT.FUND_CODE_SID,
       FACT.ACCOUNT_SID,
       DEPT_SID,
       MONTH_SID,
       FACT.LEDGER_SID,
       FACT.PRJ_SID,
       GRP_TRANS_TYPE,
       REFERENCED_BUDGET,
       REPORT_TRANS_ID,
       REF_REP_TRANS_ID,
       SCHED_DIST_LN_ID,
       REF_SCHED_DIST_LN,
       TRANS_DT,
       REF_GL_POST_DT,
       GL_POST_DT,
       KK_BUDG_TRANS_TYPE,
       ACCOUNTING_PERIOD,
       FISCAL_YEAR,
       JOURNAL_LINE,
       JOURNAL_HEADER_SRC,
       JOURNAL_DATE,
       KK_AMOUNT_TYPE,
       BUDGET_PERIOD,
       KK_REFD_DT,
       KK_DETAIL_DESCR,
       REF_REPORT_DESCR,
       MONETARY_AMT,
       (CASE
           WHEN     REFERENCED_BUDGET = 'N'
                AND GRP_TRANS_TYPE IN ('Payroll Encumbrance',
                                       'Tuition Encumbrance')
           THEN
              'Various Transactions'
           WHEN REFERENCED_BUDGET = 'N'
           THEN
              REPORT_TRANS_ID
           ELSE
              REF_REP_TRANS_ID
        END)
          Report_Transaction,
       (CASE
           WHEN     REFERENCED_BUDGET = 'N'
                AND GRP_TRANS_TYPE IN ('Expense Report',
                                       'Payroll Encumbrance',
                                       'Tuition Encumbrance')
           THEN
              'N/A'
           WHEN REFERENCED_BUDGET = 'N'
           THEN
              CASE
                 WHEN (SCHED_DIST_LN_ID IS NULL) THEN NULL
                 ELSE (' ' || SCHED_DIST_LN_ID)
              END
           ELSE
              CASE
                 WHEN (REF_SCHED_DIST_LN IS NULL) THEN NULL
                 ELSE (' ' || REF_SCHED_DIST_LN)
              END
        END)
          Schedule_Distrib_Line,
       (CASE
           WHEN     REFERENCED_BUDGET = 'N'
                AND GRP_TRANS_TYPE IN ('Payroll Encumbrance',
                                       'Tuition Encumbrance')
           THEN
              NULL
           WHEN REFERENCED_BUDGET = 'N'
           THEN
              RTRIM (KK_DETAIL_DESCR)
           ELSE
              RTRIM (REF_REPORT_DESCR)
        END)
          KK_DETAIL_DESCR_PAYROLL,
       (CASE
           WHEN REFERENCED_BUDGET = 'Y'
           THEN
              CASE
                 WHEN REF_GL_POST_DT = TO_DATE ('1-JAN-1900') THEN NULL
                 ELSE REF_GL_POST_DT
              END
           WHEN GL_POST_DT = TO_DATE ('1-JAN-1900')
           THEN
              NULL
           ELSE
              GL_POST_DT
        END)
          GL_POST_DATE_REPORT,
       (CASE
           WHEN     REFERENCED_BUDGET = 'N'
                AND GRP_TRANS_TYPE IN ('Payroll Encumbrance',
                                       'Tuition Encumbrance')
           THEN
              -1
           ELSE
              JOURNAL_LINE
        END)
          JOURNAL_LINE_REPORT,
       (CASE
           WHEN     REFERENCED_BUDGET = 'N'
                AND GRP_TRANS_TYPE IN ('Payroll Encumbrance',
                                       'Tuition Encumbrance')
           THEN
              NULL
           ELSE
              JOURNAL_DATE
        END)
          JOURNAL_DATE_REPORT,
       (CASE
           WHEN     REFERENCED_BUDGET = 'N'
                AND GRP_TRANS_TYPE IN ('Payroll Encumbrance',
                                       'Tuition Encumbrance')
           THEN
              TRANS_DT
           WHEN REFERENCED_BUDGET = 'N'
           THEN
              TRANS_DT
           ELSE
              KK_REFD_DT
        END)
          TRANSACTION_DATE_REPORT,
       (CASE
           WHEN LEDGER_TYPE IN ('1', '4')
           THEN
              (CASE
                  WHEN (    FUND_CODE IN ('191', '192', '193')
                        AND PRJ_ID LIKE '6%'
                        AND B.LEDGER NOT IN ('DETAIL_EXP'))
                  THEN
                     (0)
                  ELSE
                     (MONETARY_AMT)
               END)
           ELSE
              (0)
        END)
          ACCOUNT_BEG_BALANCE,
       (CASE
           WHEN     LEDGER_TYPE = '0'
                AND ledger_groupings1 IN ('Revenue Budget Activity',
                                          'Expense Budget Activity')
           THEN
              CASE
                 WHEN LEDGER_GROUP_TYPE = 'E'
                 THEN
                    MONETARY_AMT * -1
                 WHEN     FUND_CODE IN ('191', '192', '193')
                      AND PRJ_ID LIKE '6%'
                      AND LEDGER <> 'PRJ_BUD_DT'
                 THEN
                    0
                 ELSE
                    MONETARY_AMT
              END
           WHEN     LEDGER_TYPE IN ('1', '4')
                AND ledger_groupings1 IN ('Revenue',
                                          'Expenses and Open Commitments')
           THEN
              CASE
                 WHEN     FUND_CODE IN ('191', '192', '193')
                      AND PRJ_ID LIKE '6%'
                      AND LEDGER NOT IN ('DETAIL_EXP')
                 THEN
                    0
                 ELSE
                    MONETARY_AMT
              END
           ELSE
              0
        END)
          Transactions,
       ( (CASE
             WHEN     b.LEDGER_TYPE IN ('2', '3')
                  AND (ledger_groupings1 IN ('Revenue',
                                             'Expenses and Open Commitments',
                                             'Revenue Budget Activity',
                                             'Expense Budget Activity'))
             THEN
                MONETARY_AMT
             ELSE
                0
          END))
          Pre_Enc_EnC,
       (  (CASE
              WHEN LEDGER_TYPE IN ('1', '4')
              THEN
                 (CASE
                     WHEN (    FUND_CODE IN ('191', '192', '193')
                           AND PRJ_ID LIKE '6%'
                           AND B.LEDGER NOT IN ('DETAIL_EXP'))
                     THEN
                        (0)
                     ELSE
                        (MONETARY_AMT)
                  END)
              ELSE
                 (0)
           END)
        + (CASE
              WHEN     LEDGER_TYPE = '0'
                   AND ledger_groupings1 IN ('Revenue Budget Activity',
                                             'Expense Budget Activity')
              THEN
                 CASE
                    WHEN LEDGER_GROUP_TYPE = 'E'
                    THEN
                       MONETARY_AMT * -1
                    WHEN     FUND_CODE IN ('191', '192', '193')
                         AND PRJ_ID LIKE '6%'
                         AND LEDGER <> 'PRJ_BUD_DT'
                    THEN
                       0
                    ELSE
                       MONETARY_AMT
                 END
              WHEN     LEDGER_TYPE IN ('1', '4')
                   AND ledger_groupings1 IN ('Revenue',
                                             'Expenses and Open Commitments')
              THEN
                 CASE
                    WHEN     FUND_CODE IN ('191', '192', '193')
                         AND PRJ_ID LIKE '6%'
                         AND LEDGER NOT IN ('DETAIL_EXP')
                    THEN
                       0
                    ELSE
                       MONETARY_AMT
                 END
              ELSE
                 0
           END))
          ACCOUNT_END_BALANCE,
       ledger_groupings1 AS ledger_groupings,
       sorter1,
       TRANS_DT_SID,
       BUDGET_HDR_DESCR,
       VENDOR_NAME,
       REV_EXP_AMT,
       PAYROLL_AMT,
       PO_ID,
       REQ_ID,
       SHEETID,
       PO_LINE_DESCR,
       REQUISITION_DESCR,
       CHARTFIELD1_SID,
       PROGRAM_FDM_SID,
       AC_SID,
       DECODE (BUDGET_PERIOD, '-', '999', BUDGET_PERIOD) BUDGET_PERIOD_NUM,
       PRJ_EFF_STAT_CD PROJECT_STATUS,
       (CASE WHEN GRP_TRANS_TYPE NOT LIKE 'F%A' THEN 'A' ELSE 'D' END)
          PROMPT_FLAG,
       FACT.CLOSED_VALUE,
       JRNL_HDR_DESCR,
       CHARTFIELD1
  FROM (  SELECT TRANS_ID,
                 BU_SID,
                 FUND_CODE_SID,
                 FCT1.ACCOUNT_SID,
                 DEPT_SID,
                 MONTH_SID,
                 FCT1.LEDGER_SID,
                 PRJ_SID,
                 GRP_TRANS_TYPE,
                 REFERENCED_BUDGET,
                 REPORT_TRANS_ID,
                 REF_REP_TRANS_ID,
                 SCHED_DIST_LN_ID,
                 REF_SCHED_DIST_LN,
                 TRANS_DT,
                 REF_GL_POST_DT,
                 GL_POST_DT,
                 KK_BUDG_TRANS_TYPE,
                 ACCOUNTING_PERIOD,
                 FISCAL_YEAR,
                 JOURNAL_LINE,
                 JOURNAL_HEADER_SRC,
                 JOURNAL_DATE,
                 KK_AMOUNT_TYPE,
                 BUDGET_PERIOD,
                 KK_REFD_DT,
                 KK_DETAIL_DESCR,
                 REF_REPORT_DESCR,
                 SUM (MONETARY_AMT) MONETARY_AMT,
                 (CASE
                     WHEN (LEDGER = 'DETAIL_EXP' AND ACCT_TYPE_DESC = 'Revenue')
                     THEN
                        ('Revenue')
                     WHEN (    LEDGER_TYPE IN ('1',
                                               '2',
                                               '3',
                                               '4')
                           AND LEDGER_GROUP_TYPE = 'E')
                     THEN
                        ('Expenses and Open Commitments')
                     WHEN (LEDGER_TYPE = '0' AND LEDGER_GROUP_TYPE = 'R')
                     THEN
                        ('Revenue Budget Activity')
                     WHEN (LEDGER_TYPE = '0' AND LEDGER_GROUP_TYPE = 'E')
                     THEN
                        ('Expense Budget Activity')
                     ELSE
                        (NULL)
                  END)
                    LEDGER_GROUPINGS1,
                 (CASE
                     WHEN (LEDGER = 'DETAIL_EXP' AND ACCT_TYPE_DESC = 'Revenue')
                     THEN
                        'B'
                     WHEN (    LEDGER_TYPE IN ('1',
                                               '2',
                                               '3',
                                               '4')
                           AND LEDGER_GROUP_TYPE = 'E')
                     THEN
                        'D'
                     WHEN (LEDGER_TYPE = '0' AND LEDGER_GROUP_TYPE = 'R')
                     THEN
                        'A'
                     WHEN (LEDGER_TYPE = '0' AND LEDGER_GROUP_TYPE = 'E')
                     THEN
                        'C'
                     ELSE
                        'Z'
                  END)
                    SORTER1,
                 TRANS_DT_SID,
                 BUDGET_HDR_DESCR,
                 VENDOR_NAME,
                 SUM (REV_EXP_AMT) REV_EXP_AMT,
                 SUM (PAYROLL_AMT) PAYROLL_AMT,
                 PO_ID,
                 REQ_ID,
                 SHEETID,
                 PO_LINE_DESCR,
                 REQUISITION_DESCR,
                 CHARTFIELD1_SID,
                 PROGRAM_FDM_SID,
                 AC_SID,
                 CLOSED_VALUE,
                 JRNL_HDR_DESCR,
                 CHARTFIELD1
            FROM (SELECT FCT.*,
                         LEDGER,
                         ACCT_TYPE_DESC,
                         ACCOUNT_TYPE,
                         LEDGER_GROUP_TYPE,
                         LEDGER_TYPE
                    FROM (SELECT *
                            FROM #$OWS_SCHEMA#PS_F_KK_LDGR_AC_NU
                           WHERE trans_id IN (SELECT kk_tran_id
                                                FROM DM_FIN.PS_ETL_INT_KK_ACVTY_LOG_NU)) FCT,
                         DM_FIN.PS_D_LEDGER_NU B,
                         DM_FIN.PS_D_ACCOUNT_NU C
                   WHERE     FCT.LEDGER_SID = B.LEDGER_SID
                         AND FCT.ACCOUNT_SID = C.ACCOUNT_SID) FCT1
        GROUP BY TRANS_ID,
                 BU_SID,
                 FUND_CODE_SID,
                 FCT1.ACCOUNT_SID,
                 DEPT_SID,
                 MONTH_SID,
                 FCT1.LEDGER_SID,
                 PRJ_SID,
                 GRP_TRANS_TYPE,
                 REFERENCED_BUDGET,
                 REPORT_TRANS_ID,
                 REF_REP_TRANS_ID,
                 SCHED_DIST_LN_ID,
                 REF_SCHED_DIST_LN,
                 TRANS_DT,
                 REF_GL_POST_DT,
                 GL_POST_DT,
                 KK_BUDG_TRANS_TYPE,
                 ACCOUNTING_PERIOD,
                 FISCAL_YEAR,
                 JOURNAL_LINE,
                 JOURNAL_HEADER_SRC,
                 JOURNAL_DATE,
                 KK_AMOUNT_TYPE,
                 BUDGET_PERIOD,
                 KK_REFD_DT,
                 KK_DETAIL_DESCR,
                 REF_REPORT_DESCR,
                 (CASE
                     WHEN (    LEDGER = 'DETAIL_EXP'
                           AND ACCT_TYPE_DESC = 'Revenue')
                     THEN
                        ('Revenue')
                     WHEN (    LEDGER_TYPE IN ('1',
                                               '2',
                                               '3',
                                               '4')
                           AND LEDGER_GROUP_TYPE = 'E')
                     THEN
                        ('Expenses and Open Commitments')
                     WHEN (LEDGER_TYPE = '0' AND LEDGER_GROUP_TYPE = 'R')
                     THEN
                        ('Revenue Budget Activity')
                     WHEN (LEDGER_TYPE = '0' AND LEDGER_GROUP_TYPE = 'E')
                     THEN
                        ('Expense Budget Activity')
                     ELSE
                        (NULL)
                  END),
                 (CASE
                     WHEN (    LEDGER = 'DETAIL_EXP'
                           AND ACCT_TYPE_DESC = 'Revenue')
                     THEN
                        'B'
                     WHEN (    LEDGER_TYPE IN ('1',
                                               '2',
                                               '3',
                                               '4')
                           AND LEDGER_GROUP_TYPE = 'E')
                     THEN
                        'D'
                     WHEN (LEDGER_TYPE = '0' AND LEDGER_GROUP_TYPE = 'R')
                     THEN
                        'A'
                     WHEN (LEDGER_TYPE = '0' AND LEDGER_GROUP_TYPE = 'E')
                     THEN
                        'C'
                     ELSE
                        'Z'
                  END),
                 TRANS_DT_SID,
                 BUDGET_HDR_DESCR,
                 VENDOR_NAME,
                 PO_ID,
                 REQ_ID,
                 SHEETID,
                 PO_LINE_DESCR,
                 REQUISITION_DESCR,
                 CHARTFIELD1_SID,
                 PROGRAM_FDM_SID,
                 AC_SID,
                 CLOSED_VALUE,
                 JRNL_HDR_DESCR,
                 CHARTFIELD1) FACT,
       DM_FIN.PS_D_LEDGER_NU B,
       DM_FIN.PS_D_FUND_NU C,
       DM_FIN.ps_d_prj_nu d,
       DM_FIN.ps_d_account_nu e
 WHERE     FACT.FUND_CODE_SID = C.FUND_CODE_SID
       AND FACT.LEDGER_SID = B.LEDGER_SID
       AND FACT.PRJ_SID = D.PRJ_SID
       AND FACT.ACCOUNT_SID = E.ACCOUNT_SID
       AND TRANS_ID = '0006887247'
       AND BUDGET_PERIOD = 2014
       AND KK_DETAIL_DESCR LIKE '%Travel'
       AND SCHED_DIST_LN_ID = '-'
       AND ACCOUNTING_PERIOD = '11'
       AND FACT.ACCOUNT_SID = 1877
       AND FACT.FUND_CODE_SID = 54
       AND AC_SID = 15979